# BCE-Vir-Prediction

A virus epitope prediction tool based on ESM (Evolutionary Scale Modeling). This tool uses a pre-trained ESM classification model to perform sliding window predictions on protein sequences, identifying potential antigen epitopes and functional domains.

## Features

- **Epitope Prediction** (`bcepre_predict_logits.py`): Uses a pre-trained ESM classification model to split protein sequences with sliding windows, performs classification predictions on each subsequence (e.g., whether it is an antigen epitope, functional domain, etc.), and saves prediction results along with corresponding logits values.
- **Amino Acid Probability Prediction** (`bcepre_predict_softmax.py`): Converts sliding window prediction results into probability values aggregated by amino acid position, outputting a results table containing amino acid types, epitope probabilities, and coverage counts.

## Model

The pre-trained model can be downloaded from Hugging Face:

- **Model Repository**: [jackkuo/BCE-Vir-Prediction_model](https://huggingface.co/jackkuo/BCE-Vir-Prediction_model)

For detailed model download instructions, please refer to [`trained_esm_model/README.md`](trained_esm_model/README.md)

## Installation

Install all dependencies using `requirements.txt`:

```bash
pip install -r requirements.txt
```

If you want to download the model using Hugging Face Hub, you need to install it additionally:

```bash
pip install huggingface_hub
```

## Usage

### Step 1: Download the Model

First, download the pre-trained model to the `trained_esm_model` folder. For detailed steps, please refer to [`trained_esm_model/README.md`](trained_esm_model/README.md)

### Step 2: Prepare Input Files

Place the protein sequence file (FASTA format) to be predicted in the `example_data` folder, or modify the input file path in the script.

### Step 3: Run Epitope Prediction

Run the `bcepre_predict_logits.py` script for epitope prediction:

```bash
python bcepre_predict_logits.py
```

This script will:
- Read the protein sequence file in FASTA format
- Split the sequence using sliding windows (default minimum window size is 5)
- Perform classification predictions on each subsequence
- Output a CSV file containing the following fields:
  - `sequence`: Subsequence
  - `window_size`: Window size
  - `prediction`: Predicted class
  - `logit_0`, `logit_1`, ...: Logits values for each class

Output files are saved in the `predictions/` folder by default.

### Step 4: Calculate Amino Acid Position Probabilities

Run the `bcepre_predict_softmax.py` script to convert prediction results into aggregated probabilities by amino acid position:

```bash
python bcepre_predict_softmax.py
```

This script will:
- Read the CSV file generated by `bcepre_predict_logits.py`
- Calculate epitope probability for each subsequence (using softmax function)
- Aggregate probability values by amino acid position
- Output a CSV file containing the following fields:
  - `position`: Amino acid position (starting from 1)
  - `amino_acid`: Amino acid type
  - `probability`: Epitope probability at this position (average of all window predictions covering this position)
  - `coverage`: Number of windows covering this position

## Project Structure

```
BCE-Vir-Prediction/
├── bcepre_predict_logits.py          # Epitope prediction script
├── bcepre_predict_softmax.py         # Amino acid probability prediction script
├── requirements.txt                   # Python dependency list
├── trained_esm_model/                # Pre-trained model folder (needs to be downloaded)
│   └── README.md                     # Model download instructions
├── example_data/                     # Example data folder
│   ├── PDCoV_GDSG10_RBD_aa.fa       # Example input FASTA file
│   └── PDCoV_GDSG10_RBD_aa_8aa_logits.csv  # Example intermediate results
├── predictions/                      # Prediction output folder (auto-created)
├── README.md                         # This file
├── LICENSE                           # License file
└── .gitignore                        # Git ignore file configuration
```

## Parameter Configuration

### bcepre_predict_logits.py

The following parameters can be adjusted in the script:

- `model_path`: Model path (default: `"trained_esm_model"`)
- `fasta_file`: Input FASTA file path
- `min_window_size`: Minimum sliding window size (default: 5)
- `batch_size`: Batch size (default: 8)
- `output_file`: Output CSV file path

### bcepre_predict_softmax.py

The following parameters can be adjusted in the script:

- `input_csv`: Input CSV file path (generated by `bcepre_predict_logits.py`)
- `output_csv`: Output CSV file path

## Notes

1. Make sure the model files have been downloaded to the `trained_esm_model` folder
2. Adjust the `batch_size` parameter according to available GPU memory
3. For longer sequences, the prediction process may take a long time
4. The output folder `predictions/` will be automatically created when running the script

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.

## Citation

If you use this tool for research, please cite the relevant models and code repositories.

## Contact

For questions or suggestions, please contact us through GitHub Issues.
